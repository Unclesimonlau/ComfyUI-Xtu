import os
from ..utils import TTS_MODELS, LANGUAGE_CODES, text_translate
from ..tools.i18n.i18n import I18nAuto
from gradio_client import Client

i18n = I18nAuto()
language_list = [i18n("ä¸­æ–‡"), i18n("è‹±æ–‡"), i18n("æ—¥æ–‡"), i18n("ä¸­è‹±æ··åˆ"), i18n("æ—¥è‹±æ··åˆ"), i18n("å¤šè¯­ç§æ··åˆ")]

class Xstu_tts:
    # åˆå§‹åŒ–æ–¹æ³•ï¼Œåœ¨ç±»å®ä¾‹åŒ–æ—¶è°ƒç”¨ï¼Œå¯ä»¥åšä¸€äº›åˆå§‹åŒ–æ“ä½œï¼Œä½†å¾ˆå¤šè‡ªå®šä¹‰èŠ‚ç‚¹ç”±äºéƒ½æœ‰å„è‡ªçš„æ¨¡å—æ–‡ä»¶å¤¹ï¼Œæ‰€ä»¥é€šå¸¸æ˜¯åœ¨æ¨¡å—æ–‡ä»¶å¤¹é‡Œçš„__init__.pyæ–‡ä»¶ä¸­è¿›è¡Œåˆå§‹åŒ–æ“ä½œ
    def __init__(self):
        pass
    
    @classmethod
    def INPUT_TYPES(cls):
        how_to_cuts = [i18n("ä¸åˆ‡"), i18n("å‡‘å››å¥ä¸€åˆ‡"), i18n("å‡‘50å­—ä¸€åˆ‡"), i18n("æŒ‰ä¸­æ–‡å¥å·ã€‚åˆ‡"), i18n("æŒ‰è‹±æ–‡å¥å·.åˆ‡"), i18n("æŒ‰æ ‡ç‚¹ç¬¦å·åˆ‡"), ]
        return {
            "required": {
                "URL": ("STRING", {
                    "default":"https://tts.soohooai.com/"
                    }),
                "platform": ([*TTS_MODELS], {
                    "default": "sumi"
                    }),
                "refer_language":(language_list,{
                    "default": i18n("ä¸­æ–‡")
                    }),
                "text_language":(language_list,{
                    "default": i18n("ä¸­æ–‡")
                    }),
                "text": ("STRING",{
                    "default": "è¿™é‡Œè¾“å…¥ä½ æƒ³è¦ç”Ÿæˆè¯­è¨€çš„å†…å®¹",
                    "multiline": True
                    }),
                "how_to_cut":(how_to_cuts,{
                    "default": i18n("ä¸åˆ‡")
                    }),
                "top_k":("INT",{
                    "default":20,
                    "min":1,
                    "max": 100,
                    "step": 1,
                    "display": "slider"
                    }),
                "top_p":("FLOAT",{
                    "default":1,
                    "min":0,
                    "max": 1,
                    "step": 0.05,
                    "display": "slider"
                    }),
                "temperature":("FLOAT",{
                    "default":1,
                    "min":0,
                    "max": 1,
                    "step": 0.05,
                    "display": "slider"
                    }),
            },
            "hidden": {"prompt": "PROMPT", "extra_pnginfo": "EXTRA_PNGINFO", "unique_id": "UNIQUE_ID"},
        }
 
    RETURN_TYPES = ('AUDIO',)
    FUNCTION = "xstu_func"
    OUTPUT_NODE = False
 
    CATEGORY = "Xstu/API"
 
    def xstu_func(text, platform, refer_language, text_language, how_to_cut, top_k, top_p, temperature, temperature2):
        client = Client("https://tts.soohooai.com/")
        result = client.predict(
            param_0=text,  # è¾“å…¥æ–‡æœ¬
            param_1=platform,  # é€‰æ‹©è§’è‰²
            param_2="default",  # Emotion list
            param_3=handle_file('https://github.com/gradio-app/gradio/raw/main/test/test_files/audio_sample.wav'),  # å‚è€ƒéŸ³é¢‘è·¯å¾„
            param_4="Hello!!",  # å‚è€ƒéŸ³é¢‘æ–‡æœ¬
            param_5=refer_language,  # å‚è€ƒéŸ³é¢‘è¯­è¨€
            param_6=1,  # è¯­é€Ÿ
            param_7=text_language,  # æ–‡æœ¬è¯­è¨€
            param_8=how_to_cut,  # æ–‡æœ¬åˆ‡å‰²æ–¹æ³•
            param_9=50,  # æ–‡æœ¬åˆ‡å‰²æœ€å¤§é•¿åº¦
            param_10=10,  # æ‰¹å¤„ç†å¤§å°
            param_11=-1,  # éšæœºç§å­
            param_12=True,  # å¹¶è¡Œæ¨ç†
            param_13=top_k,  # é‡‡æ ·Top K
            param_14=top_p,  # é‡‡æ ·Top P
            param_15=temperature,  # é‡‡æ ·æ¸©åº¦
            param_16=1.35,  # é‡å¤æƒ©ç½š
            api_name="/get_audio"
)
        print(result)
 
 
# A dictionary that contains all nodes you want to export with their names
# NOTE: names should be globally unique
NODE_CLASS_MAPPINGS = {
    "xstu": Xstu_tts,
}
 
# A dictionary that contains the friendly/humanly readable titles for the nodes
NODE_DISPLAY_NAME_MAPPINGS = {
    "xstu": "è¯­éŸ³åˆæˆ",
}


def fetch_and_save_audio(character, text):
    # URL ç¼–ç 
    base_url = "https://tts.soohooai.com/tts?"
    params = {
        "character": character,
        "text": text
    }
    # å‘é€ GET è¯·æ±‚
    response = requests.get(base_url, params=params)
    
    if response.status_code == 200:
        # å°†éŸ³é¢‘æ–‡ä»¶ä¿å­˜åˆ°æœ¬åœ°
        with open("output.wav", "wb") as file:
            file.write(response.content)
        print("éŸ³é¢‘æ–‡ä»¶ä¿å­˜æˆåŠŸ")
    else:
        print(f"è¯·æ±‚å¤±è´¥ï¼ŒçŠ¶æ€ç ï¼š{response.status_code}")

# ä½¿ç”¨ç¤ºä¾‹
fetch_and_save_audio("CoCoç›´æ’­", "æˆ‘æ˜¯ä¸€ä¸ªç²‰åˆ·åŒ ")



#===============å¤‡ä»½=================

import os
import requests
import torchaudio
import time
import random
import string
from ..tools.i18n.i18n import I18nAuto
from ..utils import TTS_MODELS
from urllib.parse import quote
from gradio_client import Client

i18n = I18nAuto()
language_list = [i18n("ä¸­æ–‡"), i18n("è‹±æ–‡"), i18n("æ—¥æ–‡"), i18n("ä¸­è‹±æ··åˆ"), i18n("æ—¥è‹±æ··åˆ"), i18n("å¤šè¯­ç§æ··åˆ")]

class Xstu_tts:
    SUPPORTED_FORMATS = ('.wav', '.mp3', '.ogg', '.flac', '.aiff', '.aif')

    @classmethod
    def INPUT_TYPES(cls):
        # è·å–ç”¨æˆ·è¾“å…¥
        return {
            "required": {
                "URL": ("STRING", {
                    "default":"https://tts.soohooai.com/"
                    }),
                "stream": ([False, True], {"default": False}),
                "character": ([*TTS_MODELS], {
                    "default": "è‹æ˜",
                    "widget": "text"
                    }),   
                "text": ("STRING",{
                    "default": "è¿™é‡Œè¾“å…¥ä½ æƒ³è¦ç”Ÿæˆè¯­è¨€çš„å†…å®¹",
                    "multiline": True
                    }),
                "text_language":(language_list,{
                    "default": i18n("ä¸­æ–‡"),
                    "widget": "text"
                    }),
                "speed":("FLOAT",{
                    "default": 1,
                    "min": 1,
                    "max": 5,
                    "step": 0.05,
                    "display": "slider"
                    }),
                "top_k":("INT",{
                    "default":20,
                    "min":1,
                    "max": 100,
                    "step": 1,
                    "display": "slider"
                    }),
                "top_p":("FLOAT",{
                    "default":1,
                    "min":0,
                    "max": 1,
                    "step": 0.05,
                    "display": "slider"
                    }),
                "temperature":("FLOAT",{
                    "default":1,
                    "min":0,
                    "max": 1,
                    "step": 0.05,
                    "display": "slider"
                    }),
            }
        }

    CATEGORY = "ğŸ…Xstu/API"
    RETURN_TYPES = ("AUDIO", )
    FUNCTION = "xstu_func"

    @staticmethod
    def generate_random_filename(extension):
        """ç”Ÿæˆä¸€ä¸ªéšæœºæ–‡ä»¶å"""
        timestamp = time.strftime("%Y%m%d%H%M%S")
        random_suffix = ''.join(random.choices(string.ascii_letters + string.digits, k=5))
        return f"{timestamp}_{random_suffix}{extension}"

    def xstu_func(self, URL, stream, character, text_language, speed, top_k, top_p, temperature, text):
        # å¯¹æ–‡æœ¬è¿›è¡Œ URL ç¼–ç 
        encoded_text = quote(text)
        # æ„å»ºè¯·æ±‚URL
        url = f"{URL}/tts?stream={stream}&character={character}&text_language={text_language}&speed={speed}&top_k={top_k}&top_p={top_p}&temperature={temperature}&text={text}"
        response = requests.get(url)

        if response.status_code == 200:
            # åˆ›å»ºè¾“å‡ºç›®å½•å¦‚æœä¸å­˜åœ¨
            output_dir = '/workspace/ComfyUI/output/wav/'
            os.makedirs(output_dir, exist_ok=True)

            # ä¿å­˜æ–‡ä»¶
            file_extension = '.wav'  # å‡è®¾è¿”å›çš„éŸ³é¢‘æ ¼å¼æ˜¯wav
            random_filename = self.generate_random_filename(file_extension)
            file_path = os.path.join(output_dir, random_filename)

            with open(file_path, 'wb') as f:
                f.write(response.content)

            # åŠ è½½éŸ³é¢‘æ–‡ä»¶
            waveform, sample_rate = torchaudio.load(file_path)
            audio = {"waveform": waveform.unsqueeze(0), "sample_rate": sample_rate}
            return (audio, )
        else:
            raise Exception(f"è¯·æ±‚å¤±è´¥ï¼ŒçŠ¶æ€ç ï¼š{response.status_code}")
